
var serviceIdToPushSourceMap = 
{171:"RTA_Public_Transport_Push_Source",
172:"RTA_Public_Transport_Push_Source",
173:"RTA_Public_Transport_Push_Source",
174:"RTA_Public_Transport_Push_Source",
177:"Wojhati_Push_Source",
178:"Smart_Taxi_Push_Source",
179:"Smart_Taxi_Push_Source",
180:"RTA_Corporate_Services_Push_Source",
185:"RTA_Drivers_And_Vehicles_Push_Source",
187:"RTA_Drivers_And_Vehicles_Push_Source",
188:"RTA_Drivers_And_Vehicles_Push_Source",
189:"RTA_Drivers_And_Vehicles_Push_Source",
191:"RTA_Drivers_And_Vehicles_Push_Source",
192:"RTA_Drivers_And_Vehicles_Push_Source",
193:"RTA_Drivers_And_Vehicles_Push_Source",
195:"RTA_Drivers_And_Vehicles_Push_Source",
198:"RTA_Drivers_And_Vehicles_Push_Source",
205:"RTA_Drivers_And_Vehicles_Push_Source",
206:"RTA_Drivers_And_Vehicles_Push_Source",
208:"RTA_Drivers_And_Vehicles_Push_Source",
211:"RTA_Drivers_And_Vehicles_Push_Source",
214:"RTA_Drivers_And_Vehicles_Push_Source",
218:"RTA_Drivers_And_Vehicles_Push_Source",
220:"RTA_Drivers_And_Vehicles_Push_Source",
221:"RTA_Drivers_And_Vehicles_Push_Source",
222:"RTA_Drivers_And_Vehicles_Push_Source",
223:"RTA_Drivers_And_Vehicles_Push_Source",
225:"RTA_Drivers_And_Vehicles_Push_Source",
226:"RTA_Drivers_And_Vehicles_Push_Source",
227:"RTA_Drivers_And_Vehicles_Push_Source",
228:"RTA_Drivers_And_Vehicles_Push_Source",
229:"RTA_Drivers_And_Vehicles_Push_Source",
230:"RTA_Drivers_And_Vehicles_Push_Source",
232:"RTA_Drivers_And_Vehicles_Push_Source",
233:"RTA_Drivers_And_Vehicles_Push_Source",
234:"RTA_Drivers_And_Vehicles_Push_Source",
236:"RTA_Drivers_And_Vehicles_Push_Source",
237:"RTA_Drivers_And_Vehicles_Push_Source",
238:"RTA_Drivers_And_Vehicles_Push_Source",
239:"RTA_Drivers_And_Vehicles_Push_Source",
240:"RTA_Drivers_And_Vehicles_Push_Source",
241:"RTA_Drivers_And_Vehicles_Push_Source",
242:"RTA_Drivers_And_Vehicles_Push_Source",
243:"RTA_Corporate_Services_Push_Source",
244:"RTA_Corporate_Services_Push_Source",
248:"RTA_Corporate_Services_Push_Source",
251:"Smart_Taxi_Push_Source",
252:"Smart_Taxi_Push_Source",
253:"Smart_Taxi_Push_Source",
260:"RTA_Corporate_Services_Push_Source",
262:"RTA_Corporate_Services_Push_Source",
263:"RTA_Corporate_Services_Push_Source",
270:"RTA_Corporate_Services_Push_Source",
271:"RTA_Corporate_Services_Push_Source",
272:"RTA_Corporate_Services_Push_Source",
283:"Smart_Dubai_Parking_Push_Source",
284:"Smart_Dubai_Parking_Push_Source",
285:"RTA_Drivers_And_Vehicles_Push_Source",
296:"RTA_Corporate_Services_Push_Source",
297:"RTA_Corporate_Services_Push_Source",
299:"RTA_Corporate_Services_Push_Source",
301:"RTA_Corporate_Services_Push_Source",
302:"RTA_Corporate_Services_Push_Source",
326:"RTA_Corporate_Services_Push_Source",
328:"RTA_Corporate_Services_Push_Source",
329:"RTA_Corporate_Services_Push_Source",
332:"RTA_Corporate_Services_Push_Source",
333:"RTA_Corporate_Services_Push_Source",
338:"RTA_Public_Transport_Push_Source",
339:"RTA_Public_Transport_Push_Source",
340:"RTA_Corporate_Services_Push_Source",
341:"RTA_Corporate_Services_Push_Source",
344:"RTA_Corporate_Services_Push_Source",
345:"RTA_Corporate_Services_Push_Source",
347:"RTA_Corporate_Services_Push_Source",
1002:"RTA_Corporate_Services_Push_Source",
1005:"RTA_Public_Transport_Push_Source",
1007:"RTA_Drivers_And_Vehicles_Push_Source",
1018:"RTA_Drivers_And_Vehicles_Push_Source",
1019:"RTA_Drivers_And_Vehicles_Push_Source",
1020:"RTA_Drivers_And_Vehicles_Push_Source",
1021:"RTA_Drivers_And_Vehicles_Push_Source",
1022:"RTA_Drivers_And_Vehicles_Push_Source",
1023:"RTA_Drivers_And_Vehicles_Push_Source",
1025:"RTA_Drivers_And_Vehicles_Push_Source",
1026:"RTA_Drivers_And_Vehicles_Push_Source",
1027:"RTA_Drivers_And_Vehicles_Push_Source",
1028:"RTA_Drivers_And_Vehicles_Push_Source",
1029:"RTA_Drivers_And_Vehicles_Push_Source",
1030:"RTA_Drivers_And_Vehicles_Push_Source",
1031:"RTA_Drivers_And_Vehicles_Push_Source",
1037:"Smart_Taxi_Push_Source",
1043:"RTA_Drivers_And_Vehicles_Push_Source",
1046:"RTA_Drivers_And_Vehicles_Push_Source",
1049:"RTA_Drivers_And_Vehicles_Push_Source",
1051:"RTA_Public_Transport_Push_Source",
1060:"RTA_Drivers_And_Vehicles_Push_Source",
1061:"RTA_Drivers_And_Vehicles_Push_Source",
1063:"RTA_Drivers_And_Vehicles_Push_Source",
1064:"RTA_Public_Transport_Push_Source",
1066:"RTA_Public_Transport_Push_Source",
1067:"RTA_Public_Transport_Push_Source",
1069:"RTA_Corporate_Services_Push_Source",
1070:"RTA_Corporate_Services_Push_Source",
1074:"RTA_Drivers_And_Vehicles_Push_Source",
1075:"RTA_Drivers_And_Vehicles_Push_Source",
1083:"RTA_Drivers_And_Vehicles_Push_Source",
1084:"RTA_Corporate_Services_Push_Source",
1085:"RTA_Corporate_Services_Push_Source",
1087:"RTA_Corporate_Services_Push_Source",
1089:"RTA_Corporate_Services_Push_Source",
1090:"RTA_Corporate_Services_Push_Source",
1091:"RTA_Corporate_Services_Push_Source",
1092:"RTA_Corporate_Services_Push_Source",
1093:"RTA_Corporate_Services_Push_Source",
1095:"RTA_Corporate_Services_Push_Source",
1095:"RTA_Corporate_Services_Push_Source",
1097:"RTA_Public_Transport_Push_Source",
1098:"RTA_Public_Transport_Push_Source",
1106:"RTA_Drivers_And_Vehicles_Push_Source",
1107:"RTA_Corporate_Services_Push_Source",
1111:"RTA_Drivers_And_Vehicles_Push_Source",
1117:"RTA_Drivers_And_Vehicles_Push_Source",
1118:"RTA_Drivers_And_Vehicles_Push_Source",
1156:"RTA_Drivers_And_Vehicles_Push_Source",
1160:"Smart_Dubai_Parking_Push_Source",
1163:"RTA_Public_Transport_Push_Source",
1165:"RTA_Corporate_Services_Push_Source",
1166:"RTA_Corporate_Services_Push_Source",
1172:"RTA_Drivers_And_Vehicles_Push_Source",
1174:"RTA_Public_Transport_Push_Source",
1176:"RTA_Drivers_And_Vehicles_Push_Source",
1177:"RTA_Public_Transport_Push_Source",
1178:"RTA_Corporate_Services_Push_Source",
1179:"RTA_Corporate_Services_Push_Source",
1180:"RTA_Drivers_And_Vehicles_Push_Source",
1184:"RTA_Public_Transport_Push_Source",
1187:"RTA_Public_Transport_Push_Source",
1188:"RTA_Drivers_And_Vehicles_Push_Source",
1189:"RTA_Corporate_Services_Push_Source",
1191:"RTA_Public_Transport_Push_Source",
1193:"RTA_Public_Transport_Push_Source",
1194:"RTA_Corporate_Services_Push_Source",
1195:"RTA_Corporate_Services_Push_Source",
1196:"RTA_Public_Transport_Push_Source",
1198:"RTA_Drivers_And_Vehicles_Push_Source",
1201:"RTA_Drivers_And_Vehicles_Push_Source",
1203:"RTA_Corporate_Services_Push_Source",
1217:"RTA_Drivers_And_Vehicles_Push_Source"};

function resolveEventSource(serviceId){
	if(serviceId && serviceIdToPushSourceMap[serviceId]){
		return serviceIdToPushSourceMap[serviceId];
	}
	else{
		return 'PushEventSource';
	}
}

WL.Server.createEventSource({
	name : 'PushEventSource',
	securityTest : 'mobileTest',
	poll : {
		interval : 60,
		onPoll : 'checkNewMessages'
	}
});

WL.Server.createEventSource({
	name : 'RTA_Public_Transport_Push_Source',
	securityTest : 'mobileTest'
});

WL.Server.createEventSource({
	name : 'Smart_Taxi_Push_Source',
	securityTest : 'mobileTest'
});

WL.Server.createEventSource({
	name : 'RTA_Corporate_Services_Push_Source',
	securityTest : 'mobileTest'
});

WL.Server.createEventSource({
	name : 'RTA_Drivers_And_Vehicles_Push_Source',
	securityTest : 'mobileTest'
});

WL.Server.createEventSource({
	name : 'Smart_Dubai_Parking_Push_Source',
	securityTest : 'mobileTest'
});

WL.Server.createEventSource({
	name : 'Wojhati_Push_Source',
	securityTest : 'mobileTest'
});

function submitNotification(userId, serviceId, notificationText){
	var eventSource = resolveEventSource(serviceId);
	var userSubscription = WL.Server.getUserNotificationSubscription('PushAdapter.'+ eventSource, userId);
	
	if (userSubscription==null){
		MFP.Logger.info("No subscription found for user :: " + userId);
		return { result: "No subscription found for user :: " + userId };
	}

	var badgeDigit = 1;
	
	var notification = WL.Server.createDefaultNotification(notificationText, badgeDigit, {custom:"data"});
	
	MFP.Logger.info("submitNotification >> userId :: " + userId + ", text :: " + notificationText);
	
	WL.Server.notifyAllDevices(userSubscription, notification);
	
	return { 
		result: "Notification sent to user :: " + userId 
	};
}

function checkNewMessages() {
	var invocationData = {
			adapter : 'JmsJavaAdapter',
			procedure : 'getAllMessages',
			parameters : [ MFP.Server.getPropertyValue("tokens.jmsAdapter"] ]
		};
//	MFP.Logger.info("checkNewMessages >> calling JmsJavaAdapter.getAllMessages()"); 
	var responseMessages = MFP.Server.invokeProcedure(invocationData);
	if(responseMessages 
		&& responseMessages.isSuccessful 
		&& ( responseMessages.result instanceof Array)){
		var messages = responseMessages.result;
//		MFP.Logger.info("checkNewMessages >> Got " + messages.length + " messages.");
		for(var i=0; i<messages.length;i++){
			try{
				MFP.Logger.info("checkNewMessages >> Getting notification object"); 
				//Get notification object
				var notificationRequest = messages[i].MobilePushNotification_Request.Notification;
				if(notificationRequest.type && !(parseInt(notificationRequest.type)> 3)){
					notificationRequest.type = '1';
				}
				
				MFP.Logger.info("checkNewMessages >> preparing to save in DB"); 
				//Save to Database
				var dbInvokeParams =
					[MFP.Server.getPropertyValue("tokens.pushToken"],
					 notificationRequest.userId,
					 notificationRequest.serviceId,
					 notificationRequest.type,
					 notificationRequest.title_Ar?notificationRequest.title_Ar:'',
					 notificationRequest.title_En?notificationRequest.title_En:'',
					 notificationRequest.message_Ar?notificationRequest.message_Ar:'',
					 notificationRequest.message_En?notificationRequest.message_En:'',
					 notificationRequest.action_label_Ar?notificationRequest.action_label_Ar:'',
					 notificationRequest.action_label_En?notificationRequest.action_label_En:'',
					 notificationRequest.action_URL?notificationRequest.action_URL:'',
					 '0'];
//				MFP.Logger.info("The following is being saved" + dbInvokeParams[0] + '||'
//						 + dbInvokeParams[1] + '||' + dbInvokeParams[2] + '||' + dbInvokeParams[3] + '||'
//						 + dbInvokeParams[4] + '||' + dbInvokeParams[5] + '||' + dbInvokeParams[6] + '||'
//						 + dbInvokeParams[7] + '||' + dbInvokeParams[8] + '||' + dbInvokeParams[9] + '||'
//						 + dbInvokeParams[10] + '||' + dbInvokeParams[11]);
				MFP.Logger.info("checkNewMessages >> Saving message in DB"); 
				var dbResponse = MFP.Server.invokeProcedure({
					adapter : 'userProfile',
					procedure : 'setUserNotification',
					parameters : dbInvokeParams
				});
				
				if(dbResponse && dbResponse.isSuccessful){
					MFP.Logger.info("checkNewMessages >> Preparing to send notification to user"); 
					//Send to user
					//TODO: customize language
					var pushNotificationMsg = '';
					if(notificationRequest.title_En && notificationRequest.title_Ar){
						pushNotificationMsg = notificationRequest.title_Ar +' - '+notificationRequest.title_En;
					}
					else if(notificationRequest.title_En){
						pushNotificationMsg = notificationRequest.title_En;
					}
					else if(notificationRequest.title_Ar){
						pushNotificationMsg = notificationRequest.title_Ar;
					}
					
					if(pushNotificationMsg){
						MFP.Logger.info("checkNewMessages >> Sending notification: "+ pushNotificationMsg + "  to user: "+ notificationRequest.userId); 
						submitNotification(notificationRequest.userId, notificationRequest.serviceId, pushNotificationMsg);
					}
				}
			}
			catch(e){
				MFP.Logger.info("checkNewMessages >> Error in try/catch");
			}
		}
	}
}
